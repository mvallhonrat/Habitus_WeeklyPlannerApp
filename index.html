<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<meta content="#4f46e5" name="theme-color"/>
<meta content="Planificador Semanal basado en la Matriz de Prioridades" name="description"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<title data-i18n="title">Habitus - Planificador Semanal</title>
<!-- Cargar Tailwind CSS desde CDN -->
<div class="bg-white rounded-lg shadow-md p-4 mb-6 max-w-2xl mx-auto text-center"><div class="flex items-center justify-center gap-4 mb-2"><img alt="Logo Habitus" class="w-20 h-20 rounded-full shadow" src="icons/icon-192x192.png"/><h1 class="text-3xl font-bold text-gray-800" data-i18n="title">Planificador Semanal</h1></div><div class="mb-6" id="pasaje-inspirador"></div></div><script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
<link href="manifest.json" rel="manifest"/>
<link href="icons/icon-192x192.png" rel="apple-touch-icon"/>
<style>
    /* Optimizaciones para móvil */
    @media (max-width: 640px) {
      .text-2xl {
        font-size: 1.5rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .p-4 {
        padding: 0.75rem;
      }
      /* Aumentar tamaño de elementos interactivos para móvil */
      button, input[type="text"], select, textarea {
        min-height: 44px;
      }
      /* Aumentar espaciado entre elementos */
      .space-y-1 > * + * {
        margin-top: 0.5rem;
      }
    }

    /* Mejorar rendimiento táctil */
    .touch-manipulation {
      touch-action: manipulation;
    }

    /* Prevenir selección de texto en elementos interactivos */
    .no-select {
      user-select: none;
    }

    /* Estilos para modo standalone en iOS */
    @supports (-webkit-touch-callout: none) {
      .ios-standalone {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 antialiased ios-standalone"><script>
const pasajes = {"es": [{"contenido": "Porque donde esté tu tesoro, allí estará también tu corazón.", "pasaje": "Mateo 6:21"}, {"contenido": "Busquen primeramente el reino de Dios y su justicia, y todas estas cosas les serán añadidas.", "pasaje": "Mateo 6:33"}, {"contenido": "El mayor entre ustedes será su servidor.", "pasaje": "Mateo 23:11"}, {"contenido": "Cuando ustedes digan ‘sí’, que sea realmente sí; y cuando digan ‘no’, que sea no.", "pasaje": "Mateo 5:37"}, {"contenido": "De noche y de día, duerma o se levante, la semilla brota y crece sin que él sepa cómo.", "pasaje": "Marcos 4:27"}, {"contenido": "Traten a los demás tal y como quieren que ellos los traten a ustedes.", "pasaje": "Lucas 6:31"}, {"contenido": "Conocerán la verdad, y la verdad los hará libres.", "pasaje": "Juan 8:32"}, {"contenido": "Confía en el Señor de todo corazón, y no te apoyes en tu propia prudencia. Reconócelo en todos tus caminos, y él allanará tus sendas.", "pasaje": "Proverbios 3:5-6"}, {"contenido": "Tu palabra es una lámpara a mis pies; es una luz en mi sendero.", "pasaje": "Salmo 119:105"}, {"contenido": "Tengan cuidado de su manera de vivir. No vivan como necios sino como sabios, aprovechando bien el tiempo.", "pasaje": "Efesios 5:15-16"}, {"contenido": "Porque donde esté tu tesoro, allí estará también tu corazón.", "pasaje": "Mateo 6:21"}, {"contenido": "Busquen primeramente el reino de Dios y su justicia, y todas estas cosas les serán añadidas.", "pasaje": "Mateo 6:33"}, {"contenido": "El mayor entre ustedes será su servidor.", "pasaje": "Mateo 23:11"}, {"contenido": "Cuando ustedes digan ‘sí’, que sea realmente sí; y cuando digan ‘no’, que sea no.", "pasaje": "Mateo 5:37"}, {"contenido": "De noche y de día, duerma o se levante, la semilla brota y crece sin que él sepa cómo.", "pasaje": "Marcos 4:27"}, {"contenido": "Traten a los demás tal y como quieren que ellos los traten a ustedes.", "pasaje": "Lucas 6:31"}, {"contenido": "Conocerán la verdad, y la verdad los hará libres.", "pasaje": "Juan 8:32"}, {"contenido": "Confía en el Señor de todo corazón, y no te apoyes en tu propia prudencia. Reconócelo en todos tus caminos, y él allanará tus sendas.", "pasaje": "Proverbios 3:5-6"}, {"contenido": "Tu palabra es una lámpara a mis pies; es una luz en mi sendero.", "pasaje": "Salmo 119:105"}, {"contenido": "Tengan cuidado de su manera de vivir. No vivan como necios sino como sabios, aprovechando bien el tiempo.", "pasaje": "Efesios 5:15-16"}, {"contenido": "Porque donde esté tu tesoro, allí estará también tu corazón.", "pasaje": "Mateo 6:21"}, {"contenido": "Busquen primeramente el reino de Dios y su justicia, y todas estas cosas les serán añadidas.", "pasaje": "Mateo 6:33"}, {"contenido": "El mayor entre ustedes será su servidor.", "pasaje": "Mateo 23:11"}, {"contenido": "Cuando ustedes digan ‘sí’, que sea realmente sí; y cuando digan ‘no’, que sea no.", "pasaje": "Mateo 5:37"}, {"contenido": "De noche y de día, duerma o se levante, la semilla brota y crece sin que él sepa cómo.", "pasaje": "Marcos 4:27"}, {"contenido": "Traten a los demás tal y como quieren que ellos los traten a ustedes.", "pasaje": "Lucas 6:31"}, {"contenido": "Conocerán la verdad, y la verdad los hará libres.", "pasaje": "Juan 8:32"}, {"contenido": "Confía en el Señor de todo corazón, y no te apoyes en tu propia prudencia. Reconócelo en todos tus caminos, y él allanará tus sendas.", "pasaje": "Proverbios 3:5-6"}, {"contenido": "Tu palabra es una lámpara a mis pies; es una luz en mi sendero.", "pasaje": "Salmo 119:105"}, {"contenido": "Tengan cuidado de su manera de vivir. No vivan como necios sino como sabios, aprovechando bien el tiempo.", "pasaje": "Efesios 5:15-16"}, {"contenido": "Porque donde esté tu tesoro, allí estará también tu corazón.", "pasaje": "Mateo 6:21"}, {"contenido": "Busquen primeramente el reino de Dios y su justicia, y todas estas cosas les serán añadidas.", "pasaje": "Mateo 6:33"}, {"contenido": "El mayor entre ustedes será su servidor.", "pasaje": "Mateo 23:11"}, {"contenido": "Cuando ustedes digan ‘sí’, que sea realmente sí; y cuando digan ‘no’, que sea no.", "pasaje": "Mateo 5:37"}, {"contenido": "De noche y de día, duerma o se levante, la semilla brota y crece sin que él sepa cómo.", "pasaje": "Marcos 4:27"}, {"contenido": "Traten a los demás tal y como quieren que ellos los traten a ustedes.", "pasaje": "Lucas 6:31"}, {"contenido": "Conocerán la verdad, y la verdad los hará libres.", "pasaje": "Juan 8:32"}, {"contenido": "Confía en el Señor de todo corazón, y no te apoyes en tu propia prudencia. Reconócelo en todos tus caminos, y él allanará tus sendas.", "pasaje": "Proverbios 3:5-6"}, {"contenido": "Tu palabra es una lámpara a mis pies; es una luz en mi sendero.", "pasaje": "Salmo 119:105"}, {"contenido": "Tengan cuidado de su manera de vivir. No vivan como necios sino como sabios, aprovechando bien el tiempo.", "pasaje": "Efesios 5:15-16"}, {"contenido": "Porque donde esté tu tesoro, allí estará también tu corazón.", "pasaje": "Mateo 6:21"}, {"contenido": "Busquen primeramente el reino de Dios y su justicia, y todas estas cosas les serán añadidas.", "pasaje": "Mateo 6:33"}, {"contenido": "El mayor entre ustedes será su servidor.", "pasaje": "Mateo 23:11"}, {"contenido": "Cuando ustedes digan ‘sí’, que sea realmente sí; y cuando digan ‘no’, que sea no.", "pasaje": "Mateo 5:37"}, {"contenido": "De noche y de día, duerma o se levante, la semilla brota y crece sin que él sepa cómo.", "pasaje": "Marcos 4:27"}, {"contenido": "Traten a los demás tal y como quieren que ellos los traten a ustedes.", "pasaje": "Lucas 6:31"}, {"contenido": "Conocerán la verdad, y la verdad los hará libres.", "pasaje": "Juan 8:32"}, {"contenido": "Confía en el Señor de todo corazón, y no te apoyes en tu propia prudencia. Reconócelo en todos tus caminos, y él allanará tus sendas.", "pasaje": "Proverbios 3:5-6"}, {"contenido": "Tu palabra es una lámpara a mis pies; es una luz en mi sendero.", "pasaje": "Salmo 119:105"}, {"contenido": "Tengan cuidado de su manera de vivir. No vivan como necios sino como sabios, aprovechando bien el tiempo.", "pasaje": "Efesios 5:15-16"}], "en": [{"contenido": "For where your treasure is, there your heart will be also.", "pasaje": "Matthew 6:21"}, {"contenido": "But seek first his kingdom and his righteousness, and all these things will be given to you as well.", "pasaje": "Matthew 6:33"}, {"contenido": "The greatest among you will be your servant.", "pasaje": "Matthew 23:11"}, {"contenido": "All you need to say is simply ‘Yes’ or ‘No’; anything beyond this comes from the evil one.", "pasaje": "Matthew 5:37"}, {"contenido": "Night and day, whether he sleeps or gets up, the seed sprouts and grows, though he does not know how.", "pasaje": "Mark 4:27"}, {"contenido": "Do to others as you would have them do to you.", "pasaje": "Luke 6:31"}, {"contenido": "Then you will know the truth, and the truth will set you free.", "pasaje": "John 8:32"}, {"contenido": "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.", "pasaje": "Proverbs 3:5-6"}, {"contenido": "Your word is a lamp for my feet, a light on my path.", "pasaje": "Psalm 119:105"}, {"contenido": "Be very careful, then, how you live—not as unwise but as wise, making the most of every opportunity.", "pasaje": "Ephesians 5:15-16"}, {"contenido": "For where your treasure is, there your heart will be also.", "pasaje": "Matthew 6:21"}, {"contenido": "But seek first his kingdom and his righteousness, and all these things will be given to you as well.", "pasaje": "Matthew 6:33"}, {"contenido": "The greatest among you will be your servant.", "pasaje": "Matthew 23:11"}, {"contenido": "All you need to say is simply ‘Yes’ or ‘No’; anything beyond this comes from the evil one.", "pasaje": "Matthew 5:37"}, {"contenido": "Night and day, whether he sleeps or gets up, the seed sprouts and grows, though he does not know how.", "pasaje": "Mark 4:27"}, {"contenido": "Do to others as you would have them do to you.", "pasaje": "Luke 6:31"}, {"contenido": "Then you will know the truth, and the truth will set you free.", "pasaje": "John 8:32"}, {"contenido": "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.", "pasaje": "Proverbs 3:5-6"}, {"contenido": "Your word is a lamp for my feet, a light on my path.", "pasaje": "Psalm 119:105"}, {"contenido": "Be very careful, then, how you live—not as unwise but as wise, making the most of every opportunity.", "pasaje": "Ephesians 5:15-16"}, {"contenido": "For where your treasure is, there your heart will be also.", "pasaje": "Matthew 6:21"}, {"contenido": "But seek first his kingdom and his righteousness, and all these things will be given to you as well.", "pasaje": "Matthew 6:33"}, {"contenido": "The greatest among you will be your servant.", "pasaje": "Matthew 23:11"}, {"contenido": "All you need to say is simply ‘Yes’ or ‘No’; anything beyond this comes from the evil one.", "pasaje": "Matthew 5:37"}, {"contenido": "Night and day, whether he sleeps or gets up, the seed sprouts and grows, though he does not know how.", "pasaje": "Mark 4:27"}, {"contenido": "Do to others as you would have them do to you.", "pasaje": "Luke 6:31"}, {"contenido": "Then you will know the truth, and the truth will set you free.", "pasaje": "John 8:32"}, {"contenido": "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.", "pasaje": "Proverbs 3:5-6"}, {"contenido": "Your word is a lamp for my feet, a light on my path.", "pasaje": "Psalm 119:105"}, {"contenido": "Be very careful, then, how you live—not as unwise but as wise, making the most of every opportunity.", "pasaje": "Ephesians 5:15-16"}, {"contenido": "For where your treasure is, there your heart will be also.", "pasaje": "Matthew 6:21"}, {"contenido": "But seek first his kingdom and his righteousness, and all these things will be given to you as well.", "pasaje": "Matthew 6:33"}, {"contenido": "The greatest among you will be your servant.", "pasaje": "Matthew 23:11"}, {"contenido": "All you need to say is simply ‘Yes’ or ‘No’; anything beyond this comes from the evil one.", "pasaje": "Matthew 5:37"}, {"contenido": "Night and day, whether he sleeps or gets up, the seed sprouts and grows, though he does not know how.", "pasaje": "Mark 4:27"}, {"contenido": "Do to others as you would have them do to you.", "pasaje": "Luke 6:31"}, {"contenido": "Then you will know the truth, and the truth will set you free.", "pasaje": "John 8:32"}, {"contenido": "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.", "pasaje": "Proverbs 3:5-6"}, {"contenido": "Your word is a lamp for my feet, a light on my path.", "pasaje": "Psalm 119:105"}, {"contenido": "Be very careful, then, how you live—not as unwise but as wise, making the most of every opportunity.", "pasaje": "Ephesians 5:15-16"}, {"contenido": "For where your treasure is, there your heart will be also.", "pasaje": "Matthew 6:21"}, {"contenido": "But seek first his kingdom and his righteousness, and all these things will be given to you as well.", "pasaje": "Matthew 6:33"}, {"contenido": "The greatest among you will be your servant.", "pasaje": "Matthew 23:11"}, {"contenido": "All you need to say is simply ‘Yes’ or ‘No’; anything beyond this comes from the evil one.", "pasaje": "Matthew 5:37"}, {"contenido": "Night and day, whether he sleeps or gets up, the seed sprouts and grows, though he does not know how.", "pasaje": "Mark 4:27"}, {"contenido": "Do to others as you would have them do to you.", "pasaje": "Luke 6:31"}, {"contenido": "Then you will know the truth, and the truth will set you free.", "pasaje": "John 8:32"}, {"contenido": "Trust in the Lord with all your heart and lean not on your own understanding; in all your ways submit to him, and he will make your paths straight.", "pasaje": "Proverbs 3:5-6"}, {"contenido": "Your word is a lamp for my feet, a light on my path.", "pasaje": "Psalm 119:105"}, {"contenido": "Be very careful, then, how you live—not as unwise but as wise, making the most of every opportunity.", "pasaje": "Ephesians 5:15-16"}]};
</script>
<div class="absolute top-4 right-4 text-sm text-gray-600" id="langSelector">
<button class="mx-1 text-xl" onclick="setLanguage('es')" title="Español">🇪🇸</button>
<button class="mx-1 text-xl" onclick="setLanguage('en')" title="English">🇺🇸</button>
</div>
<!-- Título principal -->
<!-- Recuadro de instrucciones - Colapsable en móvil -->
<details class="bg-blue-100 border-l-4 border-blue-500 text-blue-900 p-3 mb-4 rounded">
<summary class="font-medium cursor-pointer no-select" data-i18n="instructions">📖 Instrucciones de uso</summary>
<ul class="list-disc list-inside text-sm space-y-1 mt-2">
<li data-i18n="inst_1">🎭 <strong>Define tus Roles:</strong> Identifica los roles importantes en tu vida (por ejemplo: Padre, Profesional, Amigo). Estos serán las categorías bajo las cuales organizarás tus tareas semanales.</li>
<li data-i18n="inst_2">📝 <strong>Agrega tus Tareas:</strong> Para cada rol, añade las tareas que deseas realizar esta semana. Escribe una breve descripción y asigna el cuadrante correspondiente según su urgencia e importancia.</li>
<li data-i18n="inst_3">🔢 <strong>Prioriza con los Cuadrantes:</strong> Utiliza la Matriz de Prioridades (I-IV) para clasificar cada tarea:
        <ul class="list-none ml-4 mt-1">
<li data-i18n="inst_4">I – Urgente e Importante (hacer de inmediato).</li>
<li data-i18n="inst_5">II – No Urgente e Importante (planificar tiempo para hacer).</li>
<li data-i18n="inst_6">III – Urgente y No Importante (intentar delegar o minimizar).</li>
<li data-i18n="inst_7">IV – No Urgente y No Importante (evitar en lo posible).</li>
</ul>
</li>
<li data-i18n="inst_8">✅ <strong>Marca las Completadas:</strong> A medida que termines cada tarea, márcala como realizada con la casilla de verificación.</li>
<li data-i18n="inst_9">🔄 <strong>Vista de Roles/Cuadrantes:</strong> Alterna entre la vista agrupada por roles o por cuadrantes usando las pestañas para obtener diferentes perspectivas de tus tareas.</li>
<li data-i18n="inst_10">📊 <strong>Revisa tus Métricas:</strong> Al finalizar la semana, revisa el resumen de tareas completadas y pendientes, y reflexiona sobre tu semana en Revisión Semanal.</li>
<li data-i18n="inst_11">📋 <strong>Exporta y Reinicia:</strong> Guarda un registro de tu semana utilizando Exportar Métricas y Exportar Tareas. Luego comienza una nueva semana con el botón Nueva Semana: solo las tareas completadas se removerán, las pendientes permanecerán para la siguiente semana.</li>
</ul>
</details>
<!-- Sección de Roles -->
<div class="mb-6">
<h2 class="text-xl font-semibold mb-2 no-select" data-i18n="roles">🎭 Definir Roles</h2>
<div class="flex gap-2">
<input class="border rounded px-3 py-2 flex-1 touch-manipulation" data-i18n-placeholder="placeholder_role" id="roleInput" placeholder="Nuevo rol..." type="text"/>
<button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 active:bg-blue-700 touch-manipulation" data-i18n="add_role" id="addRoleBtn" onclick="addRole()">
        ➕ Añadir Rol
      </button>
</div>
<div class="mt-2 space-y-1" id="rolesList"><!-- Lista de roles dinámicos --></div>
</div>
<!-- Controles: pestañas y formulario -->
<div class="mb-4">
<!-- Pestañas Roles / Cuadrantes -->
<div class="flex border-b border-gray-300 mb-3 no-select">
<button class="flex-1 px-3 py-3 text-sm font-medium text-gray-700 border-b-2 border-indigo-500 touch-manipulation" data-i18n="tabs_roles" id="tabRoles" onclick="showRoles()">Por Roles</button>
<button class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent touch-manipulation" data-i18n="tabs_quadrants" id="tabQuadrants" onclick="showQuadrants()">Por Cuadrantes</button>
</div>
<!-- Recordatorio de la última revisión -->
<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 p-3 mb-4 text-sm italic hidden" id="lastReviewBox">
      📌 <strong>Recuerda esto de la semana anterior:</strong> <span id="lastReviewText"></span>
</div>
<!-- Formulario de nueva tarea -->
<div class="mb-2">
<label class="block text-sm font-medium mb-1" data-i18n="label_task" for="taskInput">Nueva Tarea:</label>
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
<input class="border rounded px-3 py-2 text-sm w-full touch-manipulation" id="taskInput" placeholder="Descripción de la tarea" type="text"/>
<select class="border rounded px-3 py-2 text-sm w-full touch-manipulation" id="roleSelect">
<option data-i18n="opt_role" disabled="" selected="" value="">Rol</option>
</select>
<select class="border rounded px-3 py-2 text-sm w-full touch-manipulation" id="quadrantSelect">
<option data-i18n="opt_quadrant" disabled="" selected="" value="">Cuadrante</option>
<option data-i18n="q1" value="1">I - Urgente/Importante</option>
<option data-i18n="q2" value="2">II - No Urgente/Importante</option>
<option data-i18n="q3" value="3">III - Urgente/No Importante</option>
<option data-i18n="q4" value="4">IV - No Urgente/No Importante</option>
</select>
<button class="bg-green-500 text-white text-sm px-3 py-2 rounded hover:bg-green-600 active:bg-green-700 w-full touch-manipulation" data-i18n="add_task_button" onclick="addTask()">
          ✔️ Añadir Tarea
        </button>
</div>
</div>
</div>
<!-- Vistas de tareas -->
<div class="mb-6 overflow-x-hidden" id="rolesView"></div>
<div class="mb-6 hidden overflow-x-hidden" id="quadrantsView"></div>
<!-- Sección de gráficos -->
<div class="mb-6">
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="metric_quadrants">Tareas por Cuadrante</h3>
<div class="w-full h-[300px]">
<canvas id="chartQuadrants"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_title_completion">Completadas vs Pendientes</h3>
<div class="w-full h-[300px]">
<canvas id="chartCompletion"></canvas>
</div>
</div>
</div>
</div>
<!-- Sección de revisión y controles -->
<div class="mb-4">
<label class="block text-sm font-medium mb-1" data-i18n="label_review" for="reviewInput">📝 Revisión semanal:</label>
<textarea class="w-full border rounded px-3 py-2 text-sm touch-manipulation" data-i18n-placeholder="placeholder_review" id="reviewInput" placeholder="Escribe aquí una reflexión sobre tu semana..." rows="3"></textarea>
<button class="mt-3 bg-purple-600 text-white text-sm font-medium px-4 py-3 rounded hover:bg-purple-700 active:bg-purple-800 w-full sm:w-auto touch-manipulation" data-i18n="new_week" id="newWeekBtn" onclick="newWeek()">
      🌅 Nueva Semana
    </button>
</div>
<!-- Sección de métricas históricas -->
<div class="mb-6">
<h2 class="text-xl font-semibold mb-4" data-i18n="historic_metrics">📊 Métricas Históricas</h2>
<!-- Resumen de métricas actuales -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_total">Total de Tareas</h3>
<p class="text-2xl font-bold" id="totalTasks">0</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_percent">Porcentaje Completado</h3>
<p class="text-2xl font-bold" id="completionPercentage">0%</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_roles">Roles Activos</h3>
<p class="text-2xl font-bold" id="activeRoles">0</p>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-sm font-medium text-gray-500" data-i18n="metric_quadrants">Tareas por Cuadrante</h3>
<div class="grid grid-cols-2 gap-2 mt-2">
<div>
<span class="text-xs text-red-500">Q1:</span>
<span class="text-sm font-medium" id="q1Count">0</span>
</div>
<div>
<span class="text-xs text-green-500">Q2:</span>
<span class="text-sm font-medium" id="q2Count">0</span>
</div>
<div>
<span class="text-xs text-yellow-500">Q3:</span>
<span class="text-sm font-medium" id="q3Count">0</span>
</div>
<div>
<span class="text-xs text-gray-500">Q4:</span>
<span class="text-sm font-medium" id="q4Count">0</span>
</div>
</div>
</div>
</div>
<!-- Gráficos históricos -->
<div class="grid grid-cols-1 gap-4">
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_completion_title">Porcentaje de Completado por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalCompletion"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_quadrants_title">Tareas por Cuadrante por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalQuadrants"></canvas>
</div>
</div>
<div class="bg-white p-4 rounded shadow-sm">
<h3 class="text-lg font-semibold mb-2" data-i18n="chart_roles_title">Roles Activos por Semana</h3>
<div class="w-full h-[300px]">
<canvas id="chartHistoricalRoles"></canvas>
</div>
</div>
</div>
</div>
<!-- Botones de exportación -->
<div class="mb-4 grid grid-cols-2 gap-2">
<button class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation" data-i18n="export_metrics" onclick="exportCSV('metrics')">
      📥 Exportar Métricas
    </button>
<button class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation" data-i18n="export_tasks" onclick="exportCSV('tasks')">
      📥 Exportar Tareas
    </button>
</div>
<script data-i18n="metric_quadrants">
    // Variables globales
    let roles = [];
    let tasks = [];
    let metrics = [];    // histórico semanal de métricas
    let tasksLog = [];   // histórico de tareas
    let lastReviewText = "";  // última reflexión guardada
    let lastResetTime = null; // timestamp de último "Nueva Semana"
    let chartQuadrants = null;
    let chartCompletion = null;
    let chartHistoricalCompletion = null;
    let chartHistoricalQuadrants = null;
    let chartHistoricalRoles = null;

    // === Cargar datos de localStorage (si existen) al iniciar ===
    (function loadData() {
      const storedRoles = localStorage.getItem("habitus_roles");
      const storedTasks = localStorage.getItem("habitus_tasks");
      const storedMetrics = localStorage.getItem("habitus_metrics");
      const storedTasksLog = localStorage.getItem("habitus_tasksLog");
      const storedLastReview = localStorage.getItem("habitus_lastReview");
      const storedLastReset = localStorage.getItem("habitus_lastReset");

      if(storedRoles) roles = JSON.parse(storedRoles);
      if(storedTasks) tasks = JSON.parse(storedTasks);
      if(storedMetrics) metrics = JSON.parse(storedMetrics);
      if(storedTasksLog) tasksLog = JSON.parse(storedTasksLog);
      if(storedLastReview) lastReviewText = JSON.parse(storedLastReview);
      if(storedLastReset) lastResetTime = parseInt(storedLastReset);

      // Poblar dropdown de roles
      updateRoleOptions();
      
      // Mostrar última revisión si existe
      if(lastReviewText && lastReviewText.trim() !== "") {
        const lastReviewBox = document.getElementById("lastReviewBox");
        const lastReviewSpan = document.getElementById("lastReviewText");
        lastReviewSpan.textContent = lastReviewText;
        lastReviewBox.style.display = "block";
      }
    })();

    // === Función para actualizar las opciones del select de roles ===
    function updateRoleOptions() {
      const roleSelect = document.getElementById("roleSelect");
      // Limpiar opciones actuales (excepto placeholder)
      roleSelect.innerHTML = '<option value="" disabled selected>Rol</option>';
      roles.forEach(role => {
        const opt = document.createElement("option");
        opt.value = role;
        opt.textContent = role;
        roleSelect.appendChild(opt);
      });
      
      renderRoleList();
    }

    // === Inicializar gráficos Chart.js ===
    function initCharts() {
      const ctxQ = document.getElementById('chartQuadrants').getContext('2d');
      const ctxC = document.getElementById('chartCompletion').getContext('2d');
      const ctxHC = document.getElementById('chartHistoricalCompletion').getContext('2d');
      const ctxHQ = document.getElementById('chartHistoricalQuadrants').getContext('2d');
      const ctxHR = document.getElementById('chartHistoricalRoles').getContext('2d');

      // Datos iniciales para gráficos
      const quadCounts = countTasksByQuadrant();
      const compCounts = countCompletedPending();
      const historicalData = prepareHistoricalData();

      // Configuración del gráfico de barras (Cuadrantes)
      chartQuadrants = new Chart(ctxQ, {
        type: 'bar',
        data: {
          labels: ['Q1', 'Q2', 'Q3', 'Q4'],
          datasets: [{
            label: 'Tareas',
            data: quadCounts,
            backgroundColor: ['#ef4444','#22c55e','#eab308','#9ca3af'] // rojo, verde, amarillo, gris
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { 
              ticks: { color: '#374151' },
              grid: { display: false }
            },
            y: { 
              beginAtZero: true, 
              ticks: { precision: 0, color: '#374151' },
              grid: { color: '#e5e7eb' }
            }
          }
        }
      });

      // Configuración del gráfico doughnut (Completadas vs Pendientes)
      chartCompletion = new Chart(ctxC, {
        type: 'doughnut',
        data: {
          labels: ['Completadas','Pendientes'],
          datasets: [{
            data: compCounts,
            backgroundColor: ['#4ade80', '#f87171'] // verde-400, rojo-400
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 15
              }
            },
            title: { display: false }
          },
          cutout: '70%'
        }
      });

      // Configuración del gráfico de línea (Porcentaje de completado histórico)
      chartHistoricalCompletion = new Chart(ctxHC, {
        type: 'line',
        data: {
          labels: historicalData.labels,
          datasets: [{
            label: 'Porcentaje Completado',
            data: historicalData.completionPercentages,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: value => value + '%'
              }
            }
          }
        }
      });

      // Configuración del gráfico de barras (Tareas por cuadrante histórico)
      chartHistoricalQuadrants = new Chart(ctxHQ, {
        type: 'bar',
        data: {
          labels: historicalData.labels,
          datasets: [
            {
              label: 'Q1',
              data: historicalData.q1Counts,
              backgroundColor: '#ef4444'
            },
            {
              label: 'Q2',
              data: historicalData.q2Counts,
              backgroundColor: '#22c55e'
            },
            {
              label: 'Q3',
              data: historicalData.q3Counts,
              backgroundColor: '#eab308'
            },
            {
              label: 'Q4',
              data: historicalData.q4Counts,
              backgroundColor: '#9ca3af'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true }
          }
        }
      });

      // Configuración del gráfico de línea (Roles activos histórico)
      chartHistoricalRoles = new Chart(ctxHR, {
        type: 'line',
        data: {
          labels: historicalData.labels,
          datasets: [{
            label: 'Roles Activos',
            data: historicalData.activeRoles,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });

      // Actualizar métricas actuales
      updateCurrentMetrics();
    }

    // === Preparar datos históricos para gráficos ===
    function prepareHistoricalData() {
      const labels = [];
      const completionPercentages = [];
      const q1Counts = [];
      const q2Counts = [];
      const q3Counts = [];
      const q4Counts = [];
      const activeRoles = [];

      // Ordenar métricas por fecha
      const sortedMetrics = [...metrics].sort((a, b) => 
        new Date(a.fecha) - new Date(b.fecha)
      );

      sortedMetrics.forEach(metric => {
        const date = new Date(metric.fecha);
        labels.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
        completionPercentages.push(parseInt(metric.porcentaje));
        q1Counts.push(metric.q1);
        q2Counts.push(metric.q2);
        q3Counts.push(metric.q3);
        q4Counts.push(metric.q4);
        activeRoles.push(metric.roles || 0);
      });

      return {
        labels,
        completionPercentages,
        q1Counts,
        q2Counts,
        q3Counts,
        q4Counts,
        activeRoles
      };
    }

    // === Actualizar métricas actuales ===
    function updateCurrentMetrics() {
      const totalTasks = tasks.length;
      const compPend = countCompletedPending();
      const completedCount = compPend[0];
      const pendingCount = compPend[1];
      const percent = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
      const quadCounts = countTasksByQuadrant();

      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('completionPercentage').textContent = percent + '%';
      document.getElementById('activeRoles').textContent = roles.length;
      document.getElementById('q1Count').textContent = quadCounts[0];
      document.getElementById('q2Count').textContent = quadCounts[1];
      document.getElementById('q3Count').textContent = quadCounts[2];
      document.getElementById('q4Count').textContent = quadCounts[3];
    }

    // === Funciones utilitarias para contar tareas ===
    function countTasksByQuadrant() {
      // Devuelve un array [countQ1, countQ2, countQ3, countQ4]
      const counts = [0, 0, 0, 0];
      tasks.forEach(t => {
        if(t.quadrant >= 1 && t.quadrant <= 4 && t.completado !== 'ELIMINADO') {
          counts[t.quadrant - 1]++;
        }
      });
      return counts;
    }

    function countCompletedPending() {
      let completed = 0;
      let pending = 0;
      tasks.forEach(t => {
        if(t.completado === 'ELIMINADO') return;
        if(t.completed) completed++;
        else pending++;
      });
      return [completed, pending];
    }

    // === Función para renderizar las vistas de tareas (roles y cuadrantes) ===
    function renderViews() {
      const rolesDiv = document.getElementById("rolesView");
      const quadsDiv = document.getElementById("quadrantsView");
      let rolesHTML = "";
      let quadsHTML = "";

      // Construir vista por Roles
      if(roles.length === 0) {
        rolesHTML += '<p class="text-sm text-gray-500">* Agrega un rol para comenzar *</p>';
      } else {
        roles.forEach(role => {
          let roleSection = `<h3 class="text-lg font-semibold text-gray-700 mt-4">${role}</h3><ul class="ml-5 mb-2">`;
          const tasksForRole = tasks.filter(t => t.role === role && t.completado !== 'ELIMINADO');
          tasksForRole.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
          if(tasksForRole.length === 0) {
            roleSection += '<li class="text-sm text-gray-500 italic">- No hay tareas asignadas -</li>';
          } else {
            tasksForRole.forEach((t, idx) => {
              const globalIndex = tasks.indexOf(t); // índice en array global
              const checked = t.completed ? "checked" : "";
              const textStyle = t.completed ? "line-through text-gray-500" : "";
              // Determinar color de borde según cuadrante
              let borderColor = "";
              switch(t.quadrant) {
                case 1: borderColor = "border-red-500"; break;
                case 2: borderColor = "border-green-500"; break;
                case 3: borderColor = "border-yellow-500"; break;
                case 4: borderColor = "border-gray-500"; break;
              }
              roleSection += 
                `<li class="mb-1 ${borderColor} border-l-4 pl-2 text-sm ${textStyle}">
                   <input type="checkbox" class="mr-2 align-middle" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                   <span class="align-middle">${t.name}</span>
                   <button type="button" class="ml-2 text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">🗑️</button>
                 </li>`;
            });
          }
          roleSection += "</ul>";
          rolesHTML += roleSection;
        });
      }

      // Construir vista por Cuadrantes
      const quadrantTitles = [
        "I - Urgente e Importante",
        "II - No Urgente e Importante",
        "III - Urgente y No Importante",
        "IV - No Urgente y No Importante"
      ];
      const quadrantColors = [
        "bg-red-100 border-red-500",
        "bg-green-100 border-green-500",
        "bg-yellow-100 border-yellow-500",
        "bg-gray-100 border-gray-500"
      ];

      // Crear contenedor de grid 2x2
      quadsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[0]}</h3>
            <div class="${quadrantColors[0]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant1 = tasks.filter(t => t.quadrant === 1 && t.completado !== 'ELIMINADO');
      tasksForQuadrant1.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant1.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant1.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">🗑️</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[1]}</h3>
            <div class="${quadrantColors[1]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant2 = tasks.filter(t => t.quadrant === 2 && t.completado !== 'ELIMINADO');
      tasksForQuadrant2.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant2.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant2.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">🗑️</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[2]}</h3>
            <div class="${quadrantColors[2]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant3 = tasks.filter(t => t.quadrant === 3 && t.completado !== 'ELIMINADO');
      tasksForQuadrant3.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant3.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant3.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">🗑️</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[3]}</h3>
            <div class="${quadrantColors[3]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant4 = tasks.filter(t => t.quadrant === 4 && t.completado !== 'ELIMINADO');
      tasksForQuadrant4.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant4.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant4.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">🗑️</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
        </div>`;

      rolesDiv.innerHTML = rolesHTML;
      quadsDiv.innerHTML = quadsHTML;

      // Actualizar gráficos y métricas
      updateCharts();
      updateCurrentMetrics();
    }

    // === Mostrar/Ocultar vistas al hacer click en pestañas ===
    function showRoles() {
      document.getElementById("rolesView").classList.remove("hidden");
      document.getElementById("quadrantsView").classList.add("hidden");
      // Estilos pestañas activas/inactivas
      document.getElementById("tabRoles").classList.add("text-gray-700","border-indigo-500");
      document.getElementById("tabRoles").classList.remove("text-gray-600","border-transparent");
      document.getElementById("tabQuadrants").classList.remove("text-gray-700","border-indigo-500");
      document.getElementById("tabQuadrants").classList.add("text-gray-600","border-transparent");
    }

    function showQuadrants() {
      document.getElementById("quadrantsView").classList.remove("hidden");
      document.getElementById("rolesView").classList.add("hidden");
      // Estilos pestañas activas/inactivas
      document.getElementById("tabQuadrants").classList.add("text-gray-700","border-indigo-500");
      document.getElementById("tabQuadrants").classList.remove("text-gray-600","border-transparent");
      document.getElementById("tabRoles").classList.remove("text-gray-700","border-indigo-500");
      document.getElementById("tabRoles").classList.add("text-gray-600","border-transparent");
    }

    // === Añadir un nuevo rol ===
    function addRole() {
      const roleInput = document.getElementById("roleInput");
      let newRole = roleInput.value.trim();
      
      // Solo mostrar alerta si el campo está vacío
      if(newRole === "") {
        alert("Por favor ingrese un nombre de rol.");
        return;
      }
      
      // Evitar duplicados (ignorando mayúsculas/minúsculas)
      const exists = roles.some(r => r.toLowerCase() === newRole.toLowerCase());
      if(exists) {
        alert("Ese rol ya existe.");
        return;
      }
      
      // Agregar y guardar
      roles.push(newRole);
      localStorage.setItem("habitus_roles", JSON.stringify(roles));
      roleInput.value = "";
      updateRoleOptions();
      renderViews();  // actualizar la vista por roles
    }

    // === Añadir una nueva tarea ===
    function addTask() {
      const taskInput = document.getElementById("taskInput");
      const roleSelect = document.getElementById("roleSelect");
      const quadrantSelect = document.getElementById("quadrantSelect");
      const name = taskInput.value.trim();
      const role = roleSelect.value;
      const quadrant = parseInt(quadrantSelect.value);

      if(name === "") {
        alert("Por favor ingresa la descripción de la tarea.");
        return;
      }
      if(!role) {
        alert("Selecciona un rol para la tarea.");
        return;
      }
      if(isNaN(quadrant)) {
        alert("Selecciona un cuadrante (prioridad) para la tarea.");
        return;
      }
      // Crear objeto tarea
      const newTask = {
        name: name,
        role: role,
        quadrant: quadrant,
        completed: false,
        createdDate: new Date().toISOString(),
        completedDate: null
      };
      tasks.push(newTask);
      // Guardar en localStorage
      localStorage.setItem("habitus_tasks", JSON.stringify(tasks));
      // Limpiar formulario
      taskInput.value = "";
      roleSelect.value = "";
      quadrantSelect.value = "";
      // Re-renderizar vistas
      renderViews();
    }

    // === Toggle completar tarea (checkbox) ===
    function toggleTaskCompleted(index) {
      if(index < 0 || index >= tasks.length) return;
      const task = tasks[index];
      if (task.completado === 'ELIMINADO') return;
      task.completed = !task.completed;
      task.completedDate = task.completed ? new Date().toISOString() : null;
      localStorage.setItem("habitus_tasks", JSON.stringify(tasks));
      // Refrescar vistas y gráficos
      renderViews();
    }

    // === Eliminar una tarea con registro de eliminación ===
    function deleteTask(index) {
      if(index < 0 || index >= tasks.length) return;
      const task = tasks[index];
      if(!confirm("¿Estás seguro que deseas eliminar esta tarea?")) return;
      task.completado = 'ELIMINADO';
      task.completedDate = new Date().toISOString();
      localStorage.setItem("habitus_tasks", JSON.stringify(tasks));
      renderViews();
    }

    // === Actualizar datos de gráficos (llamado tras cambios en tareas) ===
    function updateCharts() {
      if(!chartQuadrants || !chartCompletion) {
        initCharts();
        return;
      }
      const quadCounts = countTasksByQuadrant();
      const compCounts = countCompletedPending();
      const historicalData = prepareHistoricalData();

      // Actualizar gráficos actuales
      chartQuadrants.data.datasets[0].data = quadCounts;
      chartQuadrants.update();
      chartCompletion.data.datasets[0].data = compCounts;
      chartCompletion.update();

      // Actualizar gráficos históricos
      chartHistoricalCompletion.data.labels = historicalData.labels;
      chartHistoricalCompletion.data.datasets[0].data = historicalData.completionPercentages;
      chartHistoricalCompletion.update();

      chartHistoricalQuadrants.data.labels = historicalData.labels;
      chartHistoricalQuadrants.data.datasets[0].data = historicalData.q1Counts;
      chartHistoricalQuadrants.data.datasets[1].data = historicalData.q2Counts;
      chartHistoricalQuadrants.data.datasets[2].data = historicalData.q3Counts;
      chartHistoricalQuadrants.data.datasets[3].data = historicalData.q4Counts;
      chartHistoricalQuadrants.update();

      chartHistoricalRoles.data.labels = historicalData.labels;
      chartHistoricalRoles.data.datasets[0].data = historicalData.activeRoles;
      chartHistoricalRoles.update();
    }

    // === Función "Nueva Semana" ===
    function newWeek() {
      const now = new Date();
      const todayDateStr = now.toISOString().slice(0,10); // formato "YYYY-MM-DD"
      // 1. Solo una vez por día
      if(localStorage.getItem("habitus_lastResetDate") === todayDateStr) {
        alert("⚠️ Ya iniciaste una nueva semana hoy. Se sobrescribirá la información anterior con los últimos cambios.");
        // Eliminar registro anterior de métricas del mismo día
        metrics = metrics.filter(m => !m.fecha.startsWith(now.toLocaleDateString('es-ES')));
        // Eliminar registros anteriores del mismo día del log de tareas
        const fechaActual = now.toLocaleDateString('es-ES');
        tasksLog = tasksLog.filter(entry => !entry.fechaCreacion.startsWith(fechaActual));
      }
      // 2. Confirmar si no pasaron 7 días
      if(lastResetTime) {
        const diffDays = (now.getTime() - lastResetTime) / (1000*60*60*24);
        if(diffDays < 7) {
          const confirmEarly = confirm("Han pasado menos de 7 días desde el último reinicio. ¿Estás seguro que deseas comenzar una nueva semana?");
          if(!confirmEarly) {
            return;
          }
        }
      }
      // 3. y 4. Registrar métricas de la semana que termina
      const totalTasks = tasks.length;
      const compPend = countCompletedPending();
      const completedCount = compPend[0];
      const pendingCount = compPend[1];
      const percent = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
      const quadCounts = countTasksByQuadrant();
      // Tomar la revisión escrita
      const reviewText = document.getElementById("reviewInput").value.trim();
      // Crear registro de métricas
      const metricsEntry = {
        fecha: now.toLocaleString('es-ES'),  // fecha actual formateada
        totales: totalTasks,
        completadas: completedCount,
        pendientes: pendingCount,
        porcentaje: percent + "%",
        q1: quadCounts[0],
        q2: quadCounts[1],
        q3: quadCounts[2],
        q4: quadCounts[3],
        roles: roles.length,
        revision: reviewText
      };
      metrics.push(metricsEntry);
      localStorage.setItem("habitus_metrics", JSON.stringify(metrics));
      // 5. Registrar detalle de tareas en log
      tasks.forEach(t => {
        // Buscar y eliminar registros anteriores de la misma tarea
        tasksLog = tasksLog.filter(logEntry => 
          !(logEntry.tarea === t.name && 
            logEntry.rol === t.role && 
            logEntry.cuadrante === t.quadrant));

        const completado = t.completado === 'ELIMINADO' ? 'ELIMINADO' : (t.completed ? 'SI' : 'NO');

        tasksLog.push({
          fechaCreacion: new Date(t.createdDate).toLocaleString('es-ES'),
          tarea: t.name,
          rol: t.role,
          cuadrante: t.quadrant,
          completado: completado,
          fechaFin: t.completedDate ? new Date(t.completedDate).toLocaleString('es-ES') : ""
        });
      });
      localStorage.setItem("habitus_tasksLog", JSON.stringify(tasksLog));
      // 6. Eliminar tareas completadas y conservar pendientes
      tasks = tasks.filter(t => !t.completed && t.completado !== 'ELIMINADO');
      localStorage.setItem("habitus_tasks", JSON.stringify(tasks));
      // 7. Guardar la última revisión para mostrarla la semana siguiente
      lastReviewText = reviewText;
      localStorage.setItem("habitus_lastReview", JSON.stringify(lastReviewText));
      // 8. Limpiar el campo de revisión para la nueva semana
      document.getElementById("reviewInput").value = "";
      // Mostrar la caja de "Recuerda esto..." con el texto recién guardado
      if(lastReviewText !== "") {
        const lastReviewBox = document.getElementById("lastReviewBox");
        const lastReviewSpan = document.getElementById("lastReviewText");
        lastReviewSpan.textContent = lastReviewText;
        lastReviewBox.style.display = "block";
      } else {
        document.getElementById("lastReviewBox").style.display = "none";
      }
      // 9. Actualizar fecha de último reinicio
      lastResetTime = now.getTime();
      localStorage.setItem("habitus_lastReset", lastResetTime.toString());
      localStorage.setItem("habitus_lastResetDate", todayDateStr);
      // 10. Refrescar vistas y gráficas para la nueva semana
      renderViews();
      alert("✅ ¡Nueva semana iniciada! Se han archivado las tareas completadas y puedes continuar con las pendientes.");
    }

    // === Exportar datos a CSV ===
    function exportCSV(type) {
      let csvContent = "";
      if(type === "metrics") {
        // Encabezados
        csvContent += "Fecha,Hora,Totales,Completadas,Pendientes,Porcentaje,Q1,Q2,Q3,Q4,Roles,Revision\n";
        metrics.forEach(entry => {
          // Escapar comas en revisión envolviendo entre comillas
          let revisionText = entry.revision;
          if(revisionText && revisionText.includes(',')) {
            revisionText = '"' + revisionText.replace(/"/g,'""') + '"';
          }
          csvContent += `${entry.fecha},${entry.totales},${entry.completadas},${entry.pendientes},${entry.porcentaje},${entry.q1},${entry.q2},${entry.q3},${entry.q4},${entry.roles},${revisionText}\n`;
        });
        downloadCSV(csvContent, "DatosMetricas.csv");
      } else if(type === "tasks") {
        csvContent += "Fecha Creacion,Hora Cracion,Tarea,Rol,Cuadrante,Completado,Fecha Fin, Hora Fin\n";
        tasksLog.forEach(entry => {
          // Escapar comas en tarea o rol si existieran
          let tareaText = entry.tarea;
          if(tareaText.includes(',')) {
            tareaText = '"' + tareaText.replace(/"/g,'""') + '"';
          }
          let rolText = entry.rol;
          if(rolText.includes(',')) {
            rolText = '"' + rolText.replace(/"/g,'""') + '"';
          }
          csvContent += `${entry.fechaCreacion},${tareaText},${rolText},${entry.cuadrante},${entry.completado},${entry.fechaFin}\n`;
        });
        downloadCSV(csvContent, "DatosTareas.csv");
      }
    }

    // Helper para descargar CSV
    function downloadCSV(csvContent, filename) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // === Función para renderizar la lista de roles ===
    function renderRoleList() {
      const rolesList = document.getElementById("rolesList");
      rolesList.innerHTML = ""; // Limpiar lista actual
      
      if(roles.length === 0) {
        rolesList.innerHTML = '<p class="text-sm text-gray-500">* No hay roles definidos *</p>';
        return;
      }
      
      roles.forEach((role, index) => {
        const roleItem = document.createElement("div");
        roleItem.className = "flex items-center justify-between bg-white p-2 rounded shadow-sm";
        roleItem.innerHTML = `
          <span class="text-sm">${role}</span>
          <button onclick="deleteRole(${index})" class="text-red-500 hover:text-red-700">
            🗑️
          </button>
        `;
        rolesList.appendChild(roleItem);
      });
    }

    // === Función para eliminar un rol ===
    function deleteRole(index) {
      const roleToDelete = roles[index];
      // Verificar si hay tareas asociadas a este rol
      const tasksForRole = tasks.filter(t => t.role === roleToDelete && t.completado !== 'ELIMINADO');
      
      if(tasksForRole.length > 0) {
        if(!confirm(`⚠️ El rol "${roleToDelete}" tiene ${tasksForRole.length} tarea(s) pendiente(s). ¿Estás seguro que deseas eliminar este rol? Las tareas asociadas también se eliminarán.`)) {
          return;
        }
      } else {
        if(!confirm(`¿Estás seguro que deseas eliminar el rol "${roleToDelete}"?`)) {
          return;
        }
      }
      
      // Eliminar el rol
      roles.splice(index, 1);
      localStorage.setItem("habitus_roles", JSON.stringify(roles));
      
      // Eliminar tareas asociadas a este rol
      tasks = tasks.filter(t => t.role !== roleToDelete);
      localStorage.setItem("habitus_tasks", JSON.stringify(tasks));
      
      // Actualizar vistas
      updateRoleOptions();
      renderViews();
    }

    // === Inicializar la aplicación al cargar la página ===
    document.addEventListener('DOMContentLoaded', () => {
      // Registrar Service Worker con ruta relativa
      if ('serviceWorker' in navigator) {
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        navigator.serviceWorker.register(basePath + 'sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      }

      renderRoleList();
      // Asegurarse de que el botón tenga el event listener correcto
      const addRoleBtn = document.getElementById("addRoleBtn");
      addRoleBtn.onclick = addRole;  // Usar onclick en lugar de addEventListener para evitar duplicados
      
      // Iniciar gráficos con datos actuales
      initCharts();
      // Renderizar vistas iniciales
      renderViews();
    });
  </script>
<script>
const lang = localStorage.getItem("habitus_lang") || "es";
const elegido = pasajes[lang][Math.floor(Math.random() * pasajes[lang].length)];
const contenedor = document.getElementById("pasaje-inspirador");
if (contenedor) {
  contenedor.innerHTML = `
    <div class='text-gray-700 text-center mt-4'>
      <p class='italic mb-1'>"${elegido.contenido}"</p>
      <p class='text-sm text-gray-500'>${elegido.pasaje}</p>
    </div>
  `;
}
</script>
<script data-i18n="metric_percent">const translations = {"es": {
    "metric_completed": "Completadas",
    "metric_pending": "Pendientes","title": "Planificador Semanal", "subtitle": "Organiza tu semana con claridad y propósito", "new_task": "Nueva tarea", "add_task": "Añadir tarea", "roles": "Definir Roles", "review": "Revisión semanal", "new_week": "🌅 Nueva Semana", "export_metrics": "📥 Exportar Métricas", "export_tasks": "📥 Exportar Tareas", "instructions": "Instrucciones de uso", "tabs_roles": "Por Roles", "tabs_quadrants": "Por Cuadrantes", "inst_1": "<li data-i18n=\"inst_1\">🎭 <strong>Define tus Roles:</strong> Identifica los roles importantes en tu vida (por ejemplo: Padre, Profesional, Amigo). Estos serán las categorías bajo las cuales organizarás tus tareas semanales.</li>", "inst_2": "<li data-i18n=\"inst_2\">📝 <strong>Agrega tus Tareas:</strong> Para cada rol, añade las tareas que deseas realizar esta semana. Escribe una breve descripción y asigna el cuadrante correspondiente según su urgencia e importancia.</li>", "inst_3": "<li data-i18n=\"inst_3\">🔢 <strong>Prioriza con los Cuadrantes:</strong> Utiliza la Matriz de Prioridades (I-IV) para clasificar cada tarea:\n        <ul class=\"list-none ml-4 mt-1\">\n<li>I – Urgente e Importante (hacer de inmediato).</li>\n<li>II – No Urgente e Importante (planificar tiempo para hacer).</li>\n<li>III – Urgente y No Importante (intentar delegar o minimizar).</li>\n<li>IV – No Urgente y No Importante (evitar en lo posible).</li>\n</ul>\n</li>", "inst_4": "<li data-i18n=\"inst_4\">I – Urgente e Importante (hacer de inmediato).</li>", "inst_5": "<li data-i18n=\"inst_5\">II – No Urgente e Importante (planificar tiempo para hacer).</li>", "inst_6": "<li data-i18n=\"inst_6\">III – Urgente y No Importante (intentar delegar o minimizar).</li>", "inst_7": "<li data-i18n=\"inst_7\">IV – No Urgente y No Importante (evitar en lo posible).</li>", "inst_8": "✅ <strong>Marca las Completadas:</strong> A medida que termines cada tarea, márcala como realizada con la casilla de verificación.", "inst_9": "🔄 <strong>Vista de Roles/Cuadrantes:</strong> Alterna entre la vista agrupada por roles o por cuadrantes usando las pestañas para obtener diferentes perspectivas de tus tareas.", "inst_10": "📊 <strong>Revisa tus Métricas:</strong> Al finalizar la semana, revisa el resumen de tareas completadas y pendientes, y reflexiona sobre tu semana en Revisión Semanal.", "inst_11": "📋 <strong>Exporta y Reinicia:</strong> Guarda un registro de tu semana utilizando Exportar Métricas y Exportar Tareas. Luego comienza una nueva semana con el botón Nueva Semana: solo las tareas completadas se removerán, las pendientes permanecerán para la siguiente semana.", "label_task": "Nueva Tarea:", "label_review": "📝 Revisión semanal:", "no_tasks": "No hay tareas asignadas", "no_tasks_simple": "Sin tareas", "placeholder_review": "Escribe aquí una reflexión sobre tu semana...", "metrics_summary": "📋 Tareas Totales: {total}, ✅ Completadas: {done}, ⏳ Pendientes: {pending}, 📈 Porcentaje completado: {percent}%", "chart_title_quadrants": "Tareas por Cuadrante", "chart_title_completion": "Completadas vs Pendientes", "placeholder_role": "Nuevo rol...", "add_role": "➕ Añadir Rol", "add_task_button": "✔️ Añadir Tarea", "historic_metrics": "📊 Métricas históricas", "metric_total": "Total de tareas", "metric_percent": "Porcentaje completado", "metric_roles": "Roles activos", "metric_quadrants": "Tareas por cuadrante", "chart_completion_title": "📈 Porcentaje de completado por semana", "chart_quadrants_title": "📊 Tareas por cuadrante por semana", "chart_roles_title": "🎭 Roles activos por semana"}, "en": {
    "metric_completed": "Completed",
    "metric_pending": "Pending","title": "Weekly Planner", "subtitle": "Plan your week with clarity and purpose", "new_task": "New task", "add_task": "Add task", "roles": "Define Roles", "review": "Weekly Review", "new_week": "🌅 New Week", "export_metrics": "📥 Export Metrics", "export_tasks": "📥 Export Tasks", "instructions": "📖 How to Use", "tabs_roles": "By Roles", "tabs_quadrants": "By Quadrants", "inst_1": "🎭 <strong>Define Your Roles:</strong> Identify the key roles in your life (e.g., Parent, Professional, Friend). These will be used to organize your weekly tasks.", "inst_2": "📝 <strong>Add Your Tasks:</strong> For each role, add tasks you want to complete this week. Write a short description and assign it to a priority quadrant.", "inst_3": "🔢 <strong>Prioritize with the Quadrants:</strong> Use Covey’s Time Management Matrix (I–IV):<ul class='list-none ml-4 mt-1'><li>I – Urgent and Important (do immediately).</li><li>II – Not Urgent but Important (schedule it).</li><li>III – Urgent but Not Important (try to delegate or minimize).</li><li>IV – Not Urgent and Not Important (avoid if possible).</li></ul>", "inst_4": "✅ <strong>Mark Completed Tasks:</strong> As you finish each task, check it off.", "inst_5": "🔄 <strong>Roles/Quadrants View:</strong> Switch views to see tasks grouped by role or by quadrant.", "inst_6": "📊 <strong>Review Metrics:</strong> At the end of the week, check your summary and reflect using the <em>Weekly Review</em>.", "inst_7": "📋 <strong>Export and Restart:</strong> Save your week’s data with <strong>Export Metrics</strong> and <strong>Export Tasks</strong>. Then start a new week: completed tasks will be removed, pending ones will remain.", "label_task": "New Task:", "label_review": "📝 Weekly Review:", "no_tasks": "No tasks assigned", "no_tasks_simple": "No tasks", "placeholder_review": "Write here your weekly reflection...", "metrics_summary": "📋 Total Tasks: {total}, ✅ Completed: {done}, ⏳ Pending: {pending}, 📈 Completion Rate: {percent}%", "chart_title_quadrants": "Tasks by Quadrant", "chart_title_completion": "Completed vs Pending", "inst_8": "✅ <strong>Mark Completed Tasks:</strong> As you finish each task, check it off using the checkbox.", "inst_9": "🔄 <strong>Roles/Quadrants View:</strong> Switch between the grouped view by roles or by quadrants for different perspectives.", "inst_10": "📊 <strong>Review Your Metrics:</strong> At the end of the week, check the summary of completed and pending tasks and reflect using the Weekly Review.", "inst_11": "📋 <strong>Export and Reset:</strong> Save a record of your week using Export Metrics and Export Tasks. Then start a new week: only completed tasks will be removed, pending ones will remain.", "placeholder_role": "New role...", "add_role": "➕ Add Role", "add_task_button": "✔️ Add Task", "historic_metrics": "📊 Historical Metrics", "metric_total": "Total Tasks", "metric_percent": "Completion Rate", "metric_roles": "Active Roles", "metric_quadrants": "Tasks by Quadrant", "chart_completion_title": "📈 Weekly Completion Percentage", "chart_quadrants_title": "📊 Tasks by Quadrant per Week", "chart_roles_title": "🎭 Active Roles per Week"}};

let currentLang = localStorage.getItem("habitus_lang") || "es";</script>
<script>
function applyTranslations(lang) {
  const t = translations[lang];

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) el.innerHTML = t[key];
  });

  document.querySelectorAll('option[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (t[key]) el.textContent = t[key];
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.getAttribute('data-i18n-placeholder');
    if (t[key]) el.placeholder = t[key];
  });

  if (typeof chartQuadrants !== "undefined" && chartQuadrants) {
    chartQuadrants.options.plugins.title.text = t.chart_title_quadrants;
    chartQuadrants.update();
  }
  if (typeof chartCompletion !== "undefined" && chartCompletion) {
    chartCompletion.options.plugins.title.text = t.chart_title_completion;
    chartCompletion.data.labels = [t.metric_completed || "Completadas", t.metric_pending || "Pendientes"];
    chartCompletion.update();
  }
  if (typeof chartHistoricalCompletion !== "undefined" && chartHistoricalCompletion) {
    chartHistoricalCompletion.options.plugins.title.text = t.chart_completion_title;
    chartHistoricalCompletion.update();
  }
  if (typeof chartHistoricalQuadrants !== "undefined" && chartHistoricalQuadrants) {
    chartHistoricalQuadrants.options.plugins.title.text = t.chart_quadrants_title;
    chartHistoricalQuadrants.update();
  }
  if (typeof chartHistoricalRoles !== "undefined" && chartHistoricalRoles) {
    chartHistoricalRoles.options.plugins.title.text = t.chart_roles_title;
    chartHistoricalRoles.update();
  }

  document.querySelector('[data-i18n="metric_total"]')?.textContent = t.metric_total;
  document.querySelector('[data-i18n="metric_percent"]')?.textContent = t.metric_percent;
  document.querySelector('[data-i18n="metric_roles"]')?.textContent = t.metric_roles;
  document.querySelector('[data-i18n="metric_quadrants"]')?.textContent = t.metric_quadrants;
}

function setLanguage(lang) {
  localStorage.setItem("habitus_lang", lang);
  applyTranslations(lang);

  const elegido = pasajes[lang][Math.floor(Math.random() * pasajes[lang].length)];
  const contenedor = document.getElementById("pasaje-inspirador");
  if (contenedor) {
    contenedor.innerHTML = `
      <div class='text-gray-700 text-center mt-4'>
        <p class='italic mb-1'>"${elegido.contenido}"</p>
        <p class='text-sm text-gray-500'>${elegido.pasaje}</p>
      </div>
    `;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const lang = localStorage.getItem("habitus_lang") || "es";
  applyTranslations(lang);
});
</script>
</body>
</html> 
