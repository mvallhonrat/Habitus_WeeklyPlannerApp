<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#4f46e5" />
  <meta name="description" content="Planificador Semanal basado en la Matriz de Prioridades" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Habitus - Planificador Semanal</title>
  <!-- Cargar Tailwind CSS desde CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3"></script>
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/icon-192x192.png" />
  <style>
    /* Optimizaciones para m√≥vil */
    @media (max-width: 640px) {
      .text-2xl {
        font-size: 1.5rem;
      }
      .text-xl {
        font-size: 1.25rem;
      }
      .p-4 {
        padding: 0.75rem;
      }
      /* Aumentar tama√±o de elementos interactivos para m√≥vil */
      button, input[type="text"], select, textarea {
        min-height: 44px;
      }
      /* Aumentar espaciado entre elementos */
      .space-y-1 > * + * {
        margin-top: 0.5rem;
      }
    }

    /* Mejorar rendimiento t√°ctil */
    .touch-manipulation {
      touch-action: manipulation;
    }

    /* Prevenir selecci√≥n de texto en elementos interactivos */
    .no-select {
      user-select: none;
    }

    /* Estilos para modo standalone en iOS */
    @supports (-webkit-touch-callout: none) {
      .ios-standalone {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
      }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 antialiased ios-standalone">
  <!-- T√≠tulo principal -->
  <h1 class="text-2xl sm:text-3xl font-bold text-center mb-2 no-select">üåü Habitus - Planificador Semanal</h1>

  <!-- Recuadro de instrucciones - Colapsable en m√≥vil -->
  <details class="bg-blue-100 border-l-4 border-blue-500 text-blue-900 p-3 mb-4 rounded">
    <summary class="font-medium cursor-pointer no-select">üìñ Instrucciones de uso</summary>
    <ul class="list-disc list-inside text-sm space-y-1 mt-2">
      <li>üé≠ <strong>Define tus Roles:</strong> Identifica los roles importantes en tu vida (por ejemplo: Padre, Profesional, Amigo). Estos ser√°n las categor√≠as bajo las cuales organizar√°s tus tareas semanales.</li>
      <li>üìù <strong>Agrega tus Tareas:</strong> Para cada rol, a√±ade las tareas que deseas realizar esta semana. Escribe una breve descripci√≥n y asigna el cuadrante correspondiente seg√∫n su urgencia e importancia.</li>
      <li>üî¢ <strong>Prioriza con los Cuadrantes:</strong> Utiliza la Matriz de Prioridades (I-IV) para clasificar cada tarea:
        <ul class="list-none ml-4 mt-1">
          <li>I ‚Äì Urgente e Importante (hacer de inmediato).</li>
          <li>II ‚Äì No Urgente e Importante (planificar tiempo para hacer).</li>
          <li>III ‚Äì Urgente y No Importante (intentar delegar o minimizar).</li>
          <li>IV ‚Äì No Urgente y No Importante (evitar en lo posible).</li>
        </ul>
      </li>
      <li>‚úÖ <strong>Marca las Completadas:</strong> A medida que termines cada tarea, m√°rcala como realizada con la casilla de verificaci√≥n.</li>
      <li>üîÑ <strong>Vista de Roles/Cuadrantes:</strong> Alterna entre la vista agrupada por roles o por cuadrantes usando las pesta√±as para obtener diferentes perspectivas de tus tareas.</li>
      <li>üìä <strong>Revisa tus M√©tricas:</strong> Al finalizar la semana, revisa el resumen de tareas completadas y pendientes, y reflexiona sobre tu semana en Revisi√≥n Semanal.</li>
      <li>üìã <strong>Exporta y Reinicia:</strong> Guarda un registro de tu semana utilizando Exportar M√©tricas y Exportar Tareas. Luego comienza una nueva semana con el bot√≥n Nueva Semana: solo las tareas completadas se remover√°n, las pendientes permanecer√°n para la siguiente semana.</li>
    </ul>
  </details>

  <!-- Secci√≥n de Roles -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-2 no-select">üé≠ Definir Roles</h2>
    <div class="flex gap-2">
      <input id="roleInput" type="text" placeholder="Nuevo rol..." 
             class="border rounded px-3 py-2 flex-1 touch-manipulation" />
      <button onclick="addRole()" id="addRoleBtn" 
              class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 active:bg-blue-700 touch-manipulation">
        ‚ûï A√±adir Rol
      </button>
    </div>
    <div id="rolesList" class="mt-2 space-y-1"><!-- Lista de roles din√°micos --></div>
  </div>

  <!-- Controles: pesta√±as y formulario -->
  <div class="mb-4">
    <!-- Pesta√±as Roles / Cuadrantes -->
    <div class="flex border-b border-gray-300 mb-3 no-select">
      <button id="tabRoles" class="flex-1 px-3 py-3 text-sm font-medium text-gray-700 border-b-2 border-indigo-500 touch-manipulation" onclick="showRoles()">Por Roles</button>
      <button id="tabQuadrants" class="flex-1 px-3 py-3 text-sm font-medium text-gray-600 hover:text-gray-800 border-b-2 border-transparent touch-manipulation" onclick="showQuadrants()">Por Cuadrantes</button>
    </div>
    <!-- Recordatorio de la √∫ltima revisi√≥n -->
    <div id="lastReviewBox" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-900 p-3 mb-4 text-sm italic hidden">
      üìå <strong>Recuerda esto de la semana anterior:</strong> <span id="lastReviewText"></span>
    </div>
    <!-- Formulario de nueva tarea -->
    <div class="mb-2">
      <label for="taskInput" class="block text-sm font-medium mb-1">Nueva Tarea:</label>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2">
        <input id="taskInput" type="text" placeholder="Descripci√≥n de la tarea" 
               class="border rounded px-3 py-2 text-sm w-full touch-manipulation" />
        <select id="roleSelect" class="border rounded px-3 py-2 text-sm w-full touch-manipulation">
          <option value="" disabled selected>Rol</option>
        </select>
        <select id="quadrantSelect" class="border rounded px-3 py-2 text-sm w-full touch-manipulation">
          <option value="" disabled selected>Cuadrante</option>
          <option value="1">I - Urgente/Importante</option>
          <option value="2">II - No Urgente/Importante</option>
          <option value="3">III - Urgente/No Importante</option>
          <option value="4">IV - No Urgente/No Importante</option>
        </select>
        <button onclick="addTask()" 
                class="bg-green-500 text-white text-sm px-3 py-2 rounded hover:bg-green-600 active:bg-green-700 w-full touch-manipulation">
          ‚úîÔ∏è A√±adir Tarea
        </button>
      </div>
    </div>
  </div>

  <!-- Vistas de tareas -->
  <div id="rolesView" class="mb-6 overflow-x-hidden"></div>
  <div id="quadrantsView" class="mb-6 hidden overflow-x-hidden"></div>

  <!-- Secci√≥n de gr√°ficos -->
  <div class="mb-6">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Tareas por Cuadrante</h3>
        <div class="w-full h-[300px]">
          <canvas id="chartQuadrants"></canvas>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Completadas vs Pendientes</h3>
        <div class="w-full h-[300px]">
          <canvas id="chartCompletion"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Secci√≥n de revisi√≥n y controles -->
  <div class="mb-4">
    <label for="reviewInput" class="block text-sm font-medium mb-1">üìù Revisi√≥n semanal:</label>
    <textarea id="reviewInput" rows="3" 
              class="w-full border rounded px-3 py-2 text-sm touch-manipulation" 
              placeholder="Escribe aqu√≠ una reflexi√≥n sobre tu semana..."></textarea>
    <button id="newWeekBtn" onclick="newWeek()" 
            class="mt-3 bg-purple-600 text-white text-sm font-medium px-4 py-3 rounded hover:bg-purple-700 active:bg-purple-800 w-full sm:w-auto touch-manipulation">
      üåÖ Nueva Semana
    </button>
  </div>

  <!-- Secci√≥n de m√©tricas hist√≥ricas -->
  <div class="mb-6">
    <h2 class="text-xl font-semibold mb-4">üìä M√©tricas Hist√≥ricas</h2>
    
    <!-- Resumen de m√©tricas actuales -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-sm font-medium text-gray-500">Total de Tareas</h3>
        <p class="text-2xl font-bold" id="totalTasks">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-sm font-medium text-gray-500">Porcentaje Completado</h3>
        <p class="text-2xl font-bold" id="completionPercentage">0%</p>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-sm font-medium text-gray-500">Roles Activos</h3>
        <p class="text-2xl font-bold" id="activeRoles">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-sm font-medium text-gray-500">Tareas por Cuadrante</h3>
        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <span class="text-xs text-red-500">Q1:</span>
            <span class="text-sm font-medium" id="q1Count">0</span>
          </div>
          <div>
            <span class="text-xs text-green-500">Q2:</span>
            <span class="text-sm font-medium" id="q2Count">0</span>
          </div>
          <div>
            <span class="text-xs text-yellow-500">Q3:</span>
            <span class="text-sm font-medium" id="q3Count">0</span>
          </div>
          <div>
            <span class="text-xs text-gray-500">Q4:</span>
            <span class="text-sm font-medium" id="q4Count">0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Gr√°ficos hist√≥ricos -->
    <div class="grid grid-cols-1 gap-4">
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Porcentaje de Completado por Semana</h3>
        <div class="w-full h-[300px]">
          <canvas id="chartHistoricalCompletion"></canvas>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Tareas por Cuadrante por Semana</h3>
        <div class="w-full h-[300px]">
          <canvas id="chartHistoricalQuadrants"></canvas>
        </div>
      </div>
      <div class="bg-white p-4 rounded shadow-sm">
        <h3 class="text-lg font-semibold mb-2">Roles Activos por Semana</h3>
        <div class="w-full h-[300px]">
          <canvas id="chartHistoricalRoles"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de exportaci√≥n -->
  <div class="mb-4 grid grid-cols-2 gap-2">
    <button onclick="exportCSV('metrics')" 
            class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation">
      üì• Exportar M√©tricas
    </button>
    <button onclick="exportCSV('tasks')" 
            class="bg-gray-300 text-gray-800 text-sm px-4 py-3 rounded hover:bg-gray-400 active:bg-gray-500 touch-manipulation">
      üì• Exportar Tareas
    </button>
  </div>

  <script>
    // Variables globales
    let roles = [];
    let tasks = [];
    let metrics = [];    // hist√≥rico semanal de m√©tricas
    let tasksLog = [];   // hist√≥rico de tareas
    let lastReviewText = "";  // √∫ltima reflexi√≥n guardada
    let lastResetTime = null; // timestamp de √∫ltimo "Nueva Semana"
    let chartQuadrants = null;
    let chartCompletion = null;
    let chartHistoricalCompletion = null;
    let chartHistoricalQuadrants = null;
    let chartHistoricalRoles = null;

    // === Cargar datos de localStorage (si existen) al iniciar ===
    (function loadData() {
      const storedRoles = localStorage.getItem("habitus_roles");
      const storedTasks = localStorage.getItem("habitus_tasks");
      const storedMetrics = localStorage.getItem("habitus_metrics");
      const storedTasksLog = localStorage.getItem("habitus_tasksLog");
      const storedLastReview = localStorage.getItem("habitus_lastReview");
      const storedLastReset = localStorage.getItem("habitus_lastReset");

      if(storedRoles) roles = JSON.parse(storedRoles);
      if(storedTasks) tasks = JSON.parse(storedTasks);
      if(storedMetrics) metrics = JSON.parse(storedMetrics);
      if(storedTasksLog) tasksLog = JSON.parse(storedTasksLog);
      if(storedLastReview) lastReviewText = JSON.parse(storedLastReview);
      if(storedLastReset) lastResetTime = parseInt(storedLastReset);

      // Poblar dropdown de roles
      updateRoleOptions();
      
      // Mostrar √∫ltima revisi√≥n si existe
      if(lastReviewText && lastReviewText.trim() !== "") {
        const lastReviewBox = document.getElementById("lastReviewBox");
        const lastReviewSpan = document.getElementById("lastReviewText");
        lastReviewSpan.textContent = lastReviewText;
        lastReviewBox.style.display = "block";
      }
    })();

    // === Funci√≥n para actualizar las opciones del select de roles ===
    function updateRoleOptions() {
      const roleSelect = document.getElementById("roleSelect");
      // Limpiar opciones actuales (excepto placeholder)
      roleSelect.innerHTML = '<option value="" disabled selected>Rol</option>';
      roles.forEach(role => {
        const opt = document.createElement("option");
        opt.value = role;
        opt.textContent = role;
        roleSelect.appendChild(opt);
      });
      
      renderRoleList();
    }

    // === Inicializar gr√°ficos Chart.js ===
    function initCharts() {
      const ctxQ = document.getElementById('chartQuadrants').getContext('2d');
      const ctxC = document.getElementById('chartCompletion').getContext('2d');
      const ctxHC = document.getElementById('chartHistoricalCompletion').getContext('2d');
      const ctxHQ = document.getElementById('chartHistoricalQuadrants').getContext('2d');
      const ctxHR = document.getElementById('chartHistoricalRoles').getContext('2d');

      // Datos iniciales para gr√°ficos
      const quadCounts = countTasksByQuadrant();
      const compCounts = countCompletedPending();
      const historicalData = prepareHistoricalData();

      // Configuraci√≥n del gr√°fico de barras (Cuadrantes)
      chartQuadrants = new Chart(ctxQ, {
        type: 'bar',
        data: {
          labels: ['Q1', 'Q2', 'Q3', 'Q4'],
          datasets: [{
            label: 'Tareas',
            data: quadCounts,
            backgroundColor: ['#ef4444','#22c55e','#eab308','#9ca3af'] // rojo, verde, amarillo, gris
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            x: { 
              ticks: { color: '#374151' },
              grid: { display: false }
            },
            y: { 
              beginAtZero: true, 
              ticks: { precision: 0, color: '#374151' },
              grid: { color: '#e5e7eb' }
            }
          }
        }
      });

      // Configuraci√≥n del gr√°fico doughnut (Completadas vs Pendientes)
      chartCompletion = new Chart(ctxC, {
        type: 'doughnut',
        data: {
          labels: ['Completadas','Pendientes'],
          datasets: [{
            data: compCounts,
            backgroundColor: ['#4ade80', '#f87171'] // verde-400, rojo-400
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 15
              }
            },
            title: { display: false }
          },
          cutout: '70%'
        }
      });

      // Configuraci√≥n del gr√°fico de l√≠nea (Porcentaje de completado hist√≥rico)
      chartHistoricalCompletion = new Chart(ctxHC, {
        type: 'line',
        data: {
          labels: historicalData.labels,
          datasets: [{
            label: 'Porcentaje Completado',
            data: historicalData.completionPercentages,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: value => value + '%'
              }
            }
          }
        }
      });

      // Configuraci√≥n del gr√°fico de barras (Tareas por cuadrante hist√≥rico)
      chartHistoricalQuadrants = new Chart(ctxHQ, {
        type: 'bar',
        data: {
          labels: historicalData.labels,
          datasets: [
            {
              label: 'Q1',
              data: historicalData.q1Counts,
              backgroundColor: '#ef4444'
            },
            {
              label: 'Q2',
              data: historicalData.q2Counts,
              backgroundColor: '#22c55e'
            },
            {
              label: 'Q3',
              data: historicalData.q3Counts,
              backgroundColor: '#eab308'
            },
            {
              label: 'Q4',
              data: historicalData.q4Counts,
              backgroundColor: '#9ca3af'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true }
          }
        }
      });

      // Configuraci√≥n del gr√°fico de l√≠nea (Roles activos hist√≥rico)
      chartHistoricalRoles = new Chart(ctxHR, {
        type: 'line',
        data: {
          labels: historicalData.labels,
          datasets: [{
            label: 'Roles Activos',
            data: historicalData.activeRoles,
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        }
      });

      // Actualizar m√©tricas actuales
      updateCurrentMetrics();
    }

    // === Preparar datos hist√≥ricos para gr√°ficos ===
    function prepareHistoricalData() {
      const labels = [];
      const completionPercentages = [];
      const q1Counts = [];
      const q2Counts = [];
      const q3Counts = [];
      const q4Counts = [];
      const activeRoles = [];

      // Ordenar m√©tricas por fecha
      const sortedMetrics = [...metrics].sort((a, b) => 
        new Date(a.fecha) - new Date(b.fecha)
      );

      sortedMetrics.forEach(metric => {
        const date = new Date(metric.fecha);
        labels.push(date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }));
        completionPercentages.push(parseInt(metric.porcentaje));
        q1Counts.push(metric.q1);
        q2Counts.push(metric.q2);
        q3Counts.push(metric.q3);
        q4Counts.push(metric.q4);
        activeRoles.push(metric.roles || 0);
      });

      return {
        labels,
        completionPercentages,
        q1Counts,
        q2Counts,
        q3Counts,
        q4Counts,
        activeRoles
      };
    }

    // === Actualizar m√©tricas actuales ===
    function updateCurrentMetrics() {
      const totalTasks = tasks.length;
      const compPend = countCompletedPending();
      const completedCount = compPend[0];
      const pendingCount = compPend[1];
      const percent = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
      const quadCounts = countTasksByQuadrant();

      document.getElementById('totalTasks').textContent = totalTasks;
      document.getElementById('completionPercentage').textContent = percent + '%';
      document.getElementById('activeRoles').textContent = roles.length;
      document.getElementById('q1Count').textContent = quadCounts[0];
      document.getElementById('q2Count').textContent = quadCounts[1];
      document.getElementById('q3Count').textContent = quadCounts[2];
      document.getElementById('q4Count').textContent = quadCounts[3];
    }

    // === Funciones utilitarias para contar tareas ===
    function countTasksByQuadrant() {
      // Devuelve un array [countQ1, countQ2, countQ3, countQ4]
      const counts = [0, 0, 0, 0];
      tasks.forEach(t => {
        if(t.quadrant >= 1 && t.quadrant <= 4 && t.completado !== 'ELIMINADO') {
          counts[t.quadrant - 1]++;
        }
      });
      return counts;
    }

    function countCompletedPending() {
      let completed = 0;
      let pending = 0;
      tasks.forEach(t => {
        if(t.completado === 'ELIMINADO') return;
        if(t.completed) completed++;
        else pending++;
      });
      return [completed, pending];
    }

    // === Funci√≥n para renderizar las vistas de tareas (roles y cuadrantes) ===
    function renderViews() {
      const rolesDiv = document.getElementById("rolesView");
      const quadsDiv = document.getElementById("quadrantsView");
      let rolesHTML = "";
      let quadsHTML = "";

      // Construir vista por Roles
      if(roles.length === 0) {
        rolesHTML += '<p class="text-sm text-gray-500">* Agrega un rol para comenzar *</p>';
      } else {
        roles.forEach(role => {
          let roleSection = `<h3 class="text-lg font-semibold text-gray-700 mt-4">${role}</h3><ul class="ml-5 mb-2">`;
          const tasksForRole = tasks.filter(t => t.role === role && t.completado !== 'ELIMINADO');
          tasksForRole.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
          if(tasksForRole.length === 0) {
            roleSection += '<li class="text-sm text-gray-500 italic">- No hay tareas asignadas -</li>';
          } else {
            tasksForRole.forEach((t, idx) => {
              const globalIndex = tasks.indexOf(t); // √≠ndice en array global
              const checked = t.completed ? "checked" : "";
              const textStyle = t.completed ? "line-through text-gray-500" : "";
              // Determinar color de borde seg√∫n cuadrante
              let borderColor = "";
              switch(t.quadrant) {
                case 1: borderColor = "border-red-500"; break;
                case 2: borderColor = "border-green-500"; break;
                case 3: borderColor = "border-yellow-500"; break;
                case 4: borderColor = "border-gray-500"; break;
              }
              roleSection += 
                `<li class="mb-1 ${borderColor} border-l-4 pl-2 text-sm ${textStyle}">
                   <input type="checkbox" class="mr-2 align-middle" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                   <span class="align-middle">${t.name}</span>
                   <button type="button" class="ml-2 text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">üóëÔ∏è</button>
                 </li>`;
            });
          }
          roleSection += "</ul>";
          rolesHTML += roleSection;
        });
      }

      // Construir vista por Cuadrantes
      const quadrantTitles = [
        "I - Urgente e Importante",
        "II - No Urgente e Importante",
        "III - Urgente y No Importante",
        "IV - No Urgente y No Importante"
      ];
      const quadrantColors = [
        "bg-red-100 border-red-500",
        "bg-green-100 border-green-500",
        "bg-yellow-100 border-yellow-500",
        "bg-gray-100 border-gray-500"
      ];

      // Crear contenedor de grid 2x2
      quadsHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[0]}</h3>
            <div class="${quadrantColors[0]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant1 = tasks.filter(t => t.quadrant === 1 && t.completado !== 'ELIMINADO');
      tasksForQuadrant1.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant1.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant1.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">üóëÔ∏è</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[1]}</h3>
            <div class="${quadrantColors[1]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant2 = tasks.filter(t => t.quadrant === 2 && t.completado !== 'ELIMINADO');
      tasksForQuadrant2.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant2.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant2.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">üóëÔ∏è</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[2]}</h3>
            <div class="${quadrantColors[2]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant3 = tasks.filter(t => t.quadrant === 3 && t.completado !== 'ELIMINADO');
      tasksForQuadrant3.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant3.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant3.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">üóëÔ∏è</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">${quadrantTitles[3]}</h3>
            <div class="${quadrantColors[3]} border-l-4 p-3 rounded">
              <ul class="space-y-2">`;
      
      const tasksForQuadrant4 = tasks.filter(t => t.quadrant === 4 && t.completado !== 'ELIMINADO');
      tasksForQuadrant4.sort((a, b) => (a.completed === b.completed) ? 0 : a.completed ? 1 : -1);
      
      if (tasksForQuadrant4.length === 0) {
        quadsHTML += '<li class="text-sm text-gray-500 italic">- No hay tareas en este cuadrante -</li>';
      } else {
        tasksForQuadrant4.forEach(t => {
          const globalIndex = tasks.indexOf(t);
          const checked = t.completed ? "checked" : "";
          const textStyle = t.completed ? "line-through text-gray-500" : "";
          quadsHTML += `
            <li class="flex items-center justify-between ${textStyle}">
              <div class="flex items-center">
                <input type="checkbox" class="mr-2" onclick="toggleTaskCompleted(${globalIndex})" ${checked}>
                <span>${t.name}</span>
              </div>
              <div class="flex items-center">
                <span class="text-xs text-gray-500 mr-2">${t.role}</span>
                <button type="button" class="text-gray-500 hover:text-red-500" onclick="deleteTask(${globalIndex})">üóëÔ∏è</button>
              </div>
            </li>`;
        });
      }
      
      quadsHTML += `
              </ul>
            </div>
          </div>
        </div>`;

      rolesDiv.innerHTML = rolesHTML;
      quadsDiv.innerHTML = quadsHTML;

      // Actualizar gr√°ficos y m√©tricas
      updateCharts();
      updateCurrentMetrics();
    }

    // === Mostrar/Ocultar vistas al hacer click en pesta√±as ===
    function showRoles() {
      document.getElementById("rolesView").classList.remove("hidden");
      document.getElementById("quadrantsView").classList.add("hidden");
      // Estilos pesta√±as activas/inactivas
      document.getElementById("tabRoles").classList.add("text-gray-700","border-indigo-500");
      document.getElementById("tabRoles").classList.remove("text-gray-600","border-transparent");
      document.getElementById("tabQuadrants").classList.remove("text-gray-700","border-indigo-500");
      document.getElementById("tabQuadrants").classList.add("text-gray-600","border-transparent");
    }

    function showQuadrants() {
      document.getElementById("quadrantsView").classList.remove("hidden");
      document.getElementById("rolesView").classList.add("hidden");
      // Estilos pesta√±as activas/inactivas
      document.getElementById("tabQuadrants").classList.add("text-gray-700","border-indigo-500");
      document.getElementById("tabQuadrants").classList.remove("text-gray-600","border-transparent");
      document.getElementById("tabRoles").classList.remove("text-gray-700","border-indigo-500");
      document.getElementById("tabRoles").classList.add("text-gray-600","border-transparent");
    }

    // === A√±adir un nuevo rol ===
    function addRole() {
      const roleInput = document.getElementById("roleInput");
      let newRole = roleInput.value.trim();
      
      // Solo mostrar alerta si el campo est√° vac√≠o
      if(newRole === "") {
        alert("Por favor ingrese un nombre de rol.");
        return;
      }
      
      // Evitar duplicados (ignorando may√∫sculas/min√∫sculas)
      const exists = roles.some(r => r.toLowerCase() === newRole.toLowerCase());
      if(exists) {
        alert("Ese rol ya existe.");
        return;
      }
      
      // Agregar y guardar
      roles.push(newRole);
      localStorage.setItem("covey_roles", JSON.stringify(roles));
      roleInput.value = "";
      updateRoleOptions();
      renderViews();  // actualizar la vista por roles
    }

    // === A√±adir una nueva tarea ===
    function addTask() {
      const taskInput = document.getElementById("taskInput");
      const roleSelect = document.getElementById("roleSelect");
      const quadrantSelect = document.getElementById("quadrantSelect");
      const name = taskInput.value.trim();
      const role = roleSelect.value;
      const quadrant = parseInt(quadrantSelect.value);

      if(name === "") {
        alert("Por favor ingresa la descripci√≥n de la tarea.");
        return;
      }
      if(!role) {
        alert("Selecciona un rol para la tarea.");
        return;
      }
      if(isNaN(quadrant)) {
        alert("Selecciona un cuadrante (prioridad) para la tarea.");
        return;
      }
      // Crear objeto tarea
      const newTask = {
        name: name,
        role: role,
        quadrant: quadrant,
        completed: false,
        createdDate: new Date().toISOString(),
        completedDate: null
      };
      tasks.push(newTask);
      // Guardar en localStorage
      localStorage.setItem("covey_tasks", JSON.stringify(tasks));
      // Limpiar formulario
      taskInput.value = "";
      roleSelect.value = "";
      quadrantSelect.value = "";
      // Re-renderizar vistas
      renderViews();
    }

    // === Toggle completar tarea (checkbox) ===
    function toggleTaskCompleted(index) {
      if(index < 0 || index >= tasks.length) return;
      const task = tasks[index];
      if (task.completado === 'ELIMINADO') return;
      task.completed = !task.completed;
      task.completedDate = task.completed ? new Date().toISOString() : null;
      localStorage.setItem("covey_tasks", JSON.stringify(tasks));
      // Refrescar vistas y gr√°ficos
      renderViews();
    }

    // === Eliminar una tarea con registro de eliminaci√≥n ===
    function deleteTask(index) {
      if(index < 0 || index >= tasks.length) return;
      const task = tasks[index];
      if(!confirm("¬øEst√°s seguro que deseas eliminar esta tarea?")) return;
      task.completado = 'ELIMINADO';
      task.completedDate = new Date().toISOString();
      localStorage.setItem("covey_tasks", JSON.stringify(tasks));
      renderViews();
    }

    // === Actualizar datos de gr√°ficos (llamado tras cambios en tareas) ===
    function updateCharts() {
      if(!chartQuadrants || !chartCompletion) {
        initCharts();
        return;
      }
      const quadCounts = countTasksByQuadrant();
      const compCounts = countCompletedPending();
      const historicalData = prepareHistoricalData();

      // Actualizar gr√°ficos actuales
      chartQuadrants.data.datasets[0].data = quadCounts;
      chartQuadrants.update();
      chartCompletion.data.datasets[0].data = compCounts;
      chartCompletion.update();

      // Actualizar gr√°ficos hist√≥ricos
      chartHistoricalCompletion.data.labels = historicalData.labels;
      chartHistoricalCompletion.data.datasets[0].data = historicalData.completionPercentages;
      chartHistoricalCompletion.update();

      chartHistoricalQuadrants.data.labels = historicalData.labels;
      chartHistoricalQuadrants.data.datasets[0].data = historicalData.q1Counts;
      chartHistoricalQuadrants.data.datasets[1].data = historicalData.q2Counts;
      chartHistoricalQuadrants.data.datasets[2].data = historicalData.q3Counts;
      chartHistoricalQuadrants.data.datasets[3].data = historicalData.q4Counts;
      chartHistoricalQuadrants.update();

      chartHistoricalRoles.data.labels = historicalData.labels;
      chartHistoricalRoles.data.datasets[0].data = historicalData.activeRoles;
      chartHistoricalRoles.update();
    }

    // === Funci√≥n "Nueva Semana" ===
    function newWeek() {
      const now = new Date();
      const todayDateStr = now.toISOString().slice(0,10); // formato "YYYY-MM-DD"
      // 1. Solo una vez por d√≠a
      if(localStorage.getItem("covey_lastResetDate") === todayDateStr) {
        alert("‚ö†Ô∏è Ya iniciaste una nueva semana hoy. Se sobrescribir√° la informaci√≥n anterior con los √∫ltimos cambios.");
        // Eliminar registro anterior de m√©tricas del mismo d√≠a
        metrics = metrics.filter(m => !m.fecha.startsWith(now.toLocaleDateString('es-ES')));
        // Eliminar registros anteriores del mismo d√≠a del log de tareas
        const fechaActual = now.toLocaleDateString('es-ES');
        tasksLog = tasksLog.filter(entry => !entry.fechaCreacion.startsWith(fechaActual));
      }
      // 2. Confirmar si no pasaron 7 d√≠as
      if(lastResetTime) {
        const diffDays = (now.getTime() - lastResetTime) / (1000*60*60*24);
        if(diffDays < 7) {
          const confirmEarly = confirm("Han pasado menos de 7 d√≠as desde el √∫ltimo reinicio. ¬øEst√°s seguro que deseas comenzar una nueva semana?");
          if(!confirmEarly) {
            return;
          }
        }
      }
      // 3. y 4. Registrar m√©tricas de la semana que termina
      const totalTasks = tasks.length;
      const compPend = countCompletedPending();
      const completedCount = compPend[0];
      const pendingCount = compPend[1];
      const percent = totalTasks > 0 ? Math.round((completedCount / totalTasks) * 100) : 0;
      const quadCounts = countTasksByQuadrant();
      // Tomar la revisi√≥n escrita
      const reviewText = document.getElementById("reviewInput").value.trim();
      // Crear registro de m√©tricas
      const metricsEntry = {
        fecha: now.toLocaleString('es-ES'),  // fecha actual formateada
        totales: totalTasks,
        completadas: completedCount,
        pendientes: pendingCount,
        porcentaje: percent + "%",
        q1: quadCounts[0],
        q2: quadCounts[1],
        q3: quadCounts[2],
        q4: quadCounts[3],
        roles: roles.length,
        revision: reviewText
      };
      metrics.push(metricsEntry);
      localStorage.setItem("covey_metrics", JSON.stringify(metrics));
      // 5. Registrar detalle de tareas en log
      tasks.forEach(t => {
        // Buscar y eliminar registros anteriores de la misma tarea
        tasksLog = tasksLog.filter(logEntry => 
          !(logEntry.tarea === t.name && 
            logEntry.rol === t.role && 
            logEntry.cuadrante === t.quadrant));

        const completado = t.completado === 'ELIMINADO' ? 'ELIMINADO' : (t.completed ? 'SI' : 'NO');

        tasksLog.push({
          fechaCreacion: new Date(t.createdDate).toLocaleString('es-ES'),
          tarea: t.name,
          rol: t.role,
          cuadrante: t.quadrant,
          completado: completado,
          fechaFin: t.completedDate ? new Date(t.completedDate).toLocaleString('es-ES') : ""
        });
      });
      localStorage.setItem("covey_tasksLog", JSON.stringify(tasksLog));
      // 6. Eliminar tareas completadas y conservar pendientes
      tasks = tasks.filter(t => !t.completed && t.completado !== 'ELIMINADO');
      localStorage.setItem("covey_tasks", JSON.stringify(tasks));
      // 7. Guardar la √∫ltima revisi√≥n para mostrarla la semana siguiente
      lastReviewText = reviewText;
      localStorage.setItem("covey_lastReview", JSON.stringify(lastReviewText));
      // 8. Limpiar el campo de revisi√≥n para la nueva semana
      document.getElementById("reviewInput").value = "";
      // Mostrar la caja de "Recuerda esto..." con el texto reci√©n guardado
      if(lastReviewText !== "") {
        const lastReviewBox = document.getElementById("lastReviewBox");
        const lastReviewSpan = document.getElementById("lastReviewText");
        lastReviewSpan.textContent = lastReviewText;
        lastReviewBox.style.display = "block";
      } else {
        document.getElementById("lastReviewBox").style.display = "none";
      }
      // 9. Actualizar fecha de √∫ltimo reinicio
      lastResetTime = now.getTime();
      localStorage.setItem("covey_lastReset", lastResetTime.toString());
      localStorage.setItem("covey_lastResetDate", todayDateStr);
      // 10. Refrescar vistas y gr√°ficas para la nueva semana
      renderViews();
      alert("‚úÖ ¬°Nueva semana iniciada! Se han archivado las tareas completadas y puedes continuar con las pendientes.");
    }

    // === Exportar datos a CSV ===
    function exportCSV(type) {
      let csvContent = "";
      if(type === "metrics") {
        // Encabezados
        csvContent += "Fecha,Hora,Totales,Completadas,Pendientes,Porcentaje,Q1,Q2,Q3,Q4,Roles,Revision\n";
        metrics.forEach(entry => {
          // Escapar comas en revisi√≥n envolviendo entre comillas
          let revisionText = entry.revision;
          if(revisionText && revisionText.includes(',')) {
            revisionText = '"' + revisionText.replace(/"/g,'""') + '"';
          }
          csvContent += `${entry.fecha},${entry.totales},${entry.completadas},${entry.pendientes},${entry.porcentaje},${entry.q1},${entry.q2},${entry.q3},${entry.q4},${entry.roles},${revisionText}\n`;
        });
        downloadCSV(csvContent, "DatosMetricas.csv");
      } else if(type === "tasks") {
        csvContent += "Fecha Creacion,Hora Cracion,Tarea,Rol,Cuadrante,Completado,Fecha Fin, Hora Fin\n";
        tasksLog.forEach(entry => {
          // Escapar comas en tarea o rol si existieran
          let tareaText = entry.tarea;
          if(tareaText.includes(',')) {
            tareaText = '"' + tareaText.replace(/"/g,'""') + '"';
          }
          let rolText = entry.rol;
          if(rolText.includes(',')) {
            rolText = '"' + rolText.replace(/"/g,'""') + '"';
          }
          csvContent += `${entry.fechaCreacion},${tareaText},${rolText},${entry.cuadrante},${entry.completado},${entry.fechaFin}\n`;
        });
        downloadCSV(csvContent, "DatosTareas.csv");
      }
    }

    // Helper para descargar CSV
    function downloadCSV(csvContent, filename) {
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // === Funci√≥n para renderizar la lista de roles ===
    function renderRoleList() {
      const rolesList = document.getElementById("rolesList");
      rolesList.innerHTML = ""; // Limpiar lista actual
      
      if(roles.length === 0) {
        rolesList.innerHTML = '<p class="text-sm text-gray-500">* No hay roles definidos *</p>';
        return;
      }
      
      roles.forEach((role, index) => {
        const roleItem = document.createElement("div");
        roleItem.className = "flex items-center justify-between bg-white p-2 rounded shadow-sm";
        roleItem.innerHTML = `
          <span class="text-sm">${role}</span>
          <button onclick="deleteRole(${index})" class="text-red-500 hover:text-red-700">
            üóëÔ∏è
          </button>
        `;
        rolesList.appendChild(roleItem);
      });
    }

    // === Funci√≥n para eliminar un rol ===
    function deleteRole(index) {
      const roleToDelete = roles[index];
      // Verificar si hay tareas asociadas a este rol
      const tasksForRole = tasks.filter(t => t.role === roleToDelete && t.completado !== 'ELIMINADO');
      
      if(tasksForRole.length > 0) {
        if(!confirm(`‚ö†Ô∏è El rol "${roleToDelete}" tiene ${tasksForRole.length} tarea(s) pendiente(s). ¬øEst√°s seguro que deseas eliminar este rol? Las tareas asociadas tambi√©n se eliminar√°n.`)) {
          return;
        }
      } else {
        if(!confirm(`¬øEst√°s seguro que deseas eliminar el rol "${roleToDelete}"?`)) {
          return;
        }
      }
      
      // Eliminar el rol
      roles.splice(index, 1);
      localStorage.setItem("covey_roles", JSON.stringify(roles));
      
      // Eliminar tareas asociadas a este rol
      tasks = tasks.filter(t => t.role !== roleToDelete);
      localStorage.setItem("covey_tasks", JSON.stringify(tasks));
      
      // Actualizar vistas
      updateRoleOptions();
      renderViews();
    }

    // === Inicializar la aplicaci√≥n al cargar la p√°gina ===
    document.addEventListener('DOMContentLoaded', () => {
      // Registrar Service Worker con ruta relativa
      if ('serviceWorker' in navigator) {
        const currentPath = window.location.pathname;
        const basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
        navigator.serviceWorker.register(basePath + 'sw.js')
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      }

      renderRoleList();
      // Asegurarse de que el bot√≥n tenga el event listener correcto
      const addRoleBtn = document.getElementById("addRoleBtn");
      addRoleBtn.onclick = addRole;  // Usar onclick en lugar de addEventListener para evitar duplicados
      
      // Iniciar gr√°ficos con datos actuales
      initCharts();
      // Renderizar vistas iniciales
      renderViews();
    });
  </script>
</body>
</html> 